{% extends "base.html" %}

{% block title %}Relatórios{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Relatórios</h1>
        {% if usuario.role == 'administracao' %}
            <a href="{{ url_for('exportar_relatorio_pdf') }}" class="btn btn-danger" target="_blank">
                <i class="fas fa-file-pdf mr-2"></i>Exportar para PDF
            </a>
        {% endif %}
    </div>

    <!-- Cards de Indicadores -->
    <div class="row mb-4">
        <!-- Indicador de Valor Total (Apenas Admin) -->
        {% if usuario.role == 'administracao' %}
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card card-indicator primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <i class="fas fa-dollar-sign fa-3x"></i>
                        <div class="text-right">
                            <div class="h3">{{ "{:,.2f}".format(valor_total|float).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
                            <div class="text-muted">Valor Total em Estoque</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Indicador de Total de Movimentações (Para todos) -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card card-indicator info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <i class="fas fa-arrows-alt-h fa-3x"></i>
                        <div class="text-right">
                            <div class="h3">{{ movimentacoes|length }}</div>
                            <div class="text-muted">Total de Movimentações</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if usuario.role == 'administracao' %}
        <!-- Indicadores de Entradas e Saídas Totais (Apenas Admin) -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card card-indicator success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <i class="fas fa-arrow-down fa-3x"></i>
                        <div class="text-right">
                            {# Assumindo que o primeiro dado em mov_por_tipo é 'Entrada' #}
                            <div class="h3">{{ dados_graficos.mov_por_tipo.data[0] | default(0) }}</div>
                            <div class="text-muted">Total de Entradas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card card-indicator danger h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <i class="fas fa-arrow-up fa-3x"></i>
                        <div class="text-right">
                            {# Assumindo que o segundo dado em mov_por_tipo é 'Saída' #}
                            <div class="h3">{{ dados_graficos.mov_por_tipo.data[1] | default(0) }}</div>
                            <div class="text-muted">Total de Saídas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- Seção de Pedidos do Usuário (Apenas para não-admins) -->
    {% if usuario.role != 'administracao' %}
    <div class="card mt-4">
        <div class="card-header">
            <h3>Meus Pedidos de Compra</h3>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Data do Pedido</th>
                        <th>Item</th>
                        <th>Quantidade</th>
                        <th>Status</th>
                        <th>Observação/Motivo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pedido in pedidos_usuario %}
                    <tr>
                        <td>{{ pedido.data_solicitacao.split(' ')[0] }}</td>
                        <td>{{ pedido.item_nome }}</td>
                        <td>{{ pedido.quantidade }}</td>
                        <td>
                            {% if pedido.status == 'aprovado' %}
                                <span class="badge badge-success">Aprovado</span>
                            {% elif pedido.status == 'rejeitado' %}
                                <span class="badge badge-danger">Rejeitado</span>
                            {% else %}
                                <span class="badge badge-warning">Pendente</span>
                            {% endif %}
                        </td>
                        <td>{{ pedido.motivo_rejeicao or pedido.justificativa }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">Você ainda não fez nenhum pedido de compra.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Gráficos (Apenas para Admin) -->
    {% if usuario.role == 'administracao' %}
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">Top 5 Itens com Maior Saída (por quantidade)</div>
                <div class="card-body"><canvas id="topSaidasChart"></canvas></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">Movimentações por Tipo</div>
                <div class="card-body"><canvas id="movimentosChart"></canvas></div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabela de Histórico de Movimentações -->
    <div class="card mt-4">
        <div class="card-header">
            <h3>Histórico de Movimentações</h3>
        </div>
        <div class="card-body">
            <div class="row mb-3 filter-container">
                {% if usuario.role == 'administracao' %}
                <div class="col-md-8">
                    <input type="text" id="filtroTabela" class="form-control" placeholder="Filtrar por item, usuário ou observação...">
                </div>
                <div class="col-md-4">
                    <select id="filtroTipo" class="form-control">
                        <option value="">Todos os Tipos</option>
                        <option value="entrada">Apenas Entradas</option>
                        <option value="saida">Apenas Saídas</option>
                    </select>
                </div>
                {% else %}
                <div class="col-12">
                    <input type="text" id="filtroTabela" class="form-control" placeholder="Filtrar por item, usuário ou observação...">
                </div>
                {% endif %}
            </div>

            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Item</th>
                        <th>Tipo</th>
                        <th>Quantidade</th>
                        <th>Usuário</th>
                        <th>Observação</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    {% for mov in movimentacoes %}
                    <tr data-tipo="{{ mov.tipo }}">
                        <td>{{ mov.data.split('.')[0] }}</td>
                        <td>{{ mov.item_nome }}</td>
                        <td>
                            {% if mov.tipo == 'entrada' %}
                                <span class="badge badge-success">Entrada</span>
                            {% else %}
                                <span class="badge badge-danger">Saída</span>
                            {% endif %}
                        </td>
                        <td>{{ mov.quantidade }}</td>
                        <td>{{ mov.usuario_nome }}</td>
                        <td>{{ mov.observacao }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">Nenhuma movimentação registrada.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Controles de Paginação -->
            <nav>
                <ul class="pagination justify-content-center">
                    {% set total_pages = (pagination_data.total / pagination_data.per_page)|round(0, 'ceil')|int %}
                    <li class="page-item {% if pagination_data.page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('ver_relatorios', page=pagination_data.page - 1) }}">Anterior</a>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">Página {{ pagination_data.page }} de {{ total_pages }}</span>
                    </li>
                    <li class="page-item {% if pagination_data.page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('ver_relatorios', page=pagination_data.page + 1) }}">Próximo</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/chart-config.js') }}"></script>
<script>
    function filtrarTabela() {
        // Se o filtro de tipo não existir (usuário não-admin), define como vazio
        let filtroTipoEl = document.getElementById('filtroTipo');
        let filtroTipo = filtroTipoEl ? filtroTipoEl.value : "";

        let filtroTexto = document.getElementById('filtroTabela').value.toLowerCase();
        let tabela = document.getElementById('corpoTabela');
        let linhas = tabela.getElementsByTagName('tr');

        for (let i = 0; i < linhas.length; i++) {
            let linha = linhas[i];
            let textoLinha = linha.textContent || linha.innerText;
            let tipoLinha = linha.getAttribute('data-tipo');

            let correspondeTexto = textoLinha.toLowerCase().indexOf(filtroTexto) > -1;
            let correspondeTipo = (filtroTipo === "") || (filtroTipo === tipoLinha);

            linha.style.display = (correspondeTexto && correspondeTipo) ? "" : "none";
        }
    }

    document.getElementById('filtroTabela').addEventListener('keyup', filtrarTabela);
    if (document.getElementById('filtroTipo')) {
        document.getElementById('filtroTipo').addEventListener('change', filtrarTabela);
    }

    // --- Configuração dos Gráficos ---
    document.addEventListener('DOMContentLoaded', function () {
        // Apenas renderiza os gráficos se o usuário for admin
        {% if usuario.role == 'administracao' %}
        // Gráfico 1: Movimentações por Tipo
        const ctxMovimentos = document.getElementById('movimentosChart').getContext('2d');
        const movimentosChart = new Chart(ctxMovimentos, {
            type: 'doughnut',
            data: {
                labels: {{ dados_graficos.mov_por_tipo.labels | tojson }},
                datasets: [{
                    label: 'Total de Movimentações',
                    data: {{ dados_graficos.mov_por_tipo.data | tojson }},
                    backgroundColor: ['#28a745', '#dc3545'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' }
                },
                // Ação de clique para filtrar a tabela
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const clickedLabel = movimentosChart.data.labels[elements[0].index].toLowerCase();
                        const filtroDropdown = document.getElementById('filtroTipo');
                        // Mapeia o label do gráfico para o valor do dropdown
                        const valorFiltro = clickedLabel === 'entrada' ? 'entrada' : 'saida';
                        filtroDropdown.value = valorFiltro;
                        filtrarTabela(); // Chama a função de filtro da tabela
                    }
                }
            }
        });
        
        const ctxTopSaidas = document.getElementById('topSaidasChart').getContext('2d'); // Gráfico 2: Top 5 Saídas
        new Chart(ctxTopSaidas, {
            type: 'bar',
            data: {
                labels: {{ dados_graficos.top_saidas.labels | tojson }},
                datasets: [{
                    label: 'Quantidade Total de Saída',
                    data: {{ dados_graficos.top_saidas.data | tojson }},
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // Barras horizontais para melhor leitura
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                // Ação de clique para filtrar a tabela pelo nome do item
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const clickedLabel = ctxTopSaidas.canvas.chart.data.labels[elements[0].index];
                        const filtroInput = document.getElementById('filtroTabela');
                        filtroInput.value = clickedLabel;
                        filtrarTabela(); // Chama a função de filtro da tabela
                    }
                }
            }
        });
        {% endif %}
    });
</script>
{% endblock %}